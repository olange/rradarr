<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>Class: Exam</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/exam.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="Object.html">Object</a>
  
</nav>

    <!-- Included Modules -->
<nav id="includes-section" class="section">
  <h3 class="section-header">Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="DICOMElementsHelper.html">DICOMElementsHelper</a>
  
  
  </ul>
</nav>

    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-csv_metadata_header">#csv_metadata_header</a>
    
    <li><a href="#method-i-empty-3F">#empty?</a>
    
    <li><a href="#method-i-has_homogeneous_structure-3F">#has_homogeneous_structure?</a>
    
    <li><a href="#method-i-has_images-3F">#has_images?</a>
    
    <li><a href="#method-i-has_scouts-3F">#has_scouts?</a>
    
    <li><a href="#method-i-images_already_read-3F">#images_already_read?</a>
    
    <li><a href="#method-i-read_images">#read_images</a>
    
    <li><a href="#method-i-sort_images_by">#sort_images_by</a>
    
    <li><a href="#method-i-sort_images_by-21">#sort_images_by!</a>
    
    <li><a href="#method-i-source_dir-3D">#source_dir=</a>
    
    <li><a href="#method-i-to_csv">#to_csv</a>
    
    <li><a href="#method-i-to_html">#to_html</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./COPYING.html">COPYING</a>
  
    <li class="file"><a href="./Gemfile.html">Gemfile</a>
  
    <li class="file"><a href="./README_rdoc.html">README</a>
  
    <li class="file"><a href="./test/fixtures/README_fixtures_rdoc.html">README_fixtures</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./DICOMElementsHelper.html">DICOMElementsHelper</a>
  
    <li><a href="./Exam.html">Exam</a>
  
    <li><a href="./ExamCruncher.html">ExamCruncher</a>
  
    <li><a href="./Object.html">Object</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class Exam</h1>

  <div id="description" class="description">
    
<p>Lit un jeu d’images DICOM d’un examen radiologique de type CTscan à partir
d’un dossier source, en distinguant les images « scout » des images de
l’examen lui-même. Permet d’extraire les métadonnées du jeu d’images de
l’examen et de les exporter au format CSV.</p>

<p>Le dossier source peut contenir un jeu de fichiers hétérogènes, par exemple
texte et images DICOM. Les fichiers images DICOM sont identifiés par
lecture et analyse de leur en-tête.</p>

<p>Usage courant, pour exporter les métadonnées:</p>

<pre class="ruby"><span class="ruby-identifier">exam</span> = <span class="ruby-constant">Exam</span>.<span class="ruby-identifier">new</span>( <span class="ruby-string">&quot;images/exam001/&quot;</span>)
<span class="ruby-identifier">open</span>( <span class="ruby-string">&quot;exam001.csv&quot;</span>, <span class="ruby-string">&quot;w+&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">exam</span>.<span class="ruby-identifier">to_csv</span>( <span class="ruby-identifier">file</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>Pour investiguer le jeu d’images d’un examen:</p>

<pre>exam = Exam.new( &quot;images/exam001/&quot;)
exam.read_images
puts exam.name
puts exam.images.keys
puts exam.scouts.keys</pre>

<p>Noter que le jeu d’images demeure invariant une fois que les images ont été
chargées par l’invocation de la méthode <a
href="Exam.html#method-i-read_images">#read_images</a>; des appels
subséquents n’ont plus d’effet.</p>

<p>En changeant la valeur de la variable d’instance <a
href="Exam.html#attribute-i-source_dir">#source_dir</a>, il est cependant
possible de forcer une réinitialisation et de réutiliser un objet <a
href="Exam.html">Exam</a>; si sa valeur change effectivement, il faut alors
invoquer à nouveau la méthode read_image.</p>

<p>Nomenclature des noms de variables:</p>
<ul><li>
<p><code>image</code>: désigne un tuple <code>'PATH' =&gt;
DICOM::DObject</code>.</p>
</li><li>
<p><code>scout</code>: idem, désigne un tuple <code>'PATH' =&gt;
DICOM::DObject</code>.</p>
</li><li>
<p><code>dobject</code>: désigne un objet <code>DICOM::DObject</code>.</p>
</li><li>
<p><code>path</code>: désigne le plus souvent un chemin d’accès à un fichier
source DICOM.</p>
</li></ul>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="DEFAULT_CSV_OPTIONS">DEFAULT_CSV_OPTIONS
        
        <dd class="description"><p>Paramètres de conversion CSV par défaut (voir description du module CSV)</p>
        
      
        <dt id="DEFAULT_OPTIONS">DEFAULT_OPTIONS
        
        <dd class="description"><p>Options d’extraction par défaut</p>
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-images" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">images</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Collection des images de l’examen (<code>'PATH' =&gt;
DICOM::DObject</code>).</p>

<p>Il s’agit d’un hash, dont la <em>clé</em> est le chemin d’accès (path) au
fichier source et la <em>valeur</em> est l’objet DICOM correspondant,
obtenu par le décodage du fichier source.</p>

<p>Pour extraire et traiter un élément, voici quelques idiomes valides:</p>

<pre class="ruby"><span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span> = <span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>[<span class="ruby-value">1</span>]
<span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span> = <span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">first</span>
<span class="ruby-identifier">dobject</span> = <span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>[ <span class="ruby-string">'&lt;PATH&gt;'</span>]
<span class="ruby-identifier">dobject</span> = <span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">values</span>[ <span class="ruby-constant">INDEX</span>]
<span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span> <span class="ruby-operator">...</span> }
<span class="ruby-identifier">exam</span>.<span class="ruby-identifier">images</span>.<span class="ruby-identifier">each_value</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span> <span class="ruby-operator">...</span> }
</pre>

<p>Noter que dans les deux premiers exemples, on accède de façon
<em>positionnelle</em> à un élément du hash (non par la clé). Dans ce cas,
un hash Ruby retourne un <em>tableau avec deux éléments</em>, le premier
contenant la clé (path) et le second contenant la valeur (l’objet DICOM).</p>
        
        </div>
      </div>
      
      <div id="attribute-i-name" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">name</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Nom de l’examen (composé d’après la description du jeu d’images, voir
méthode extract_exam_name)</p>
        
        </div>
      </div>
      
      <div id="attribute-i-options_extract" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">options_extract</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Options d’extraction; voir <a
href="Exam.html#DEFAULT_OPTIONS">DEFAULT_OPTIONS</a> pour les valeurs
possibles.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-scouts" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">scouts</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Collection des « images scout » de l’examen (<code>'PATH' =&gt;
DICOM::DObject</code>). Ces images, également désignées « localizers »,
présentent une vue d’ensemble transversale correspondant aux images de
l’examen. Il s’agit d’un hash de structure semblable à celle de la
collection <code>images</code>.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-source_dir" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">source_dir</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Dossier source dans lequel se trouvent les images DICOM à traiter</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">( dir_path = nil, options = {})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Créé un nouvel examen à partir du jeu d’images DICOM qui se trouve dans un
dossier source. Si aucun dossier n’est comuniqué, il pourra l’être
ultérieurement en invoquant la méthode <a
href="Exam.html#attribute-i-source_dir">#source_dir</a>=</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>( <span class="ruby-identifier">dir_path</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">options</span> = {})
  <span class="ruby-identifier">reset!</span>
  <span class="ruby-ivar">@options_extract</span> = <span class="ruby-constant">DEFAULT_OPTIONS</span>.<span class="ruby-identifier">merge</span>( <span class="ruby-identifier">options</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">source_dir</span> = <span class="ruby-identifier">dir_path</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-csv_metadata_header" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">csv_metadata_header</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne un tableau contenant les noms des colonnes qui se trouveraient
dans l’en-tête du fichier CSV lorsque l’on exporte les métadonnées (voir la
méthode <a href="Exam.html#method-i-to_csv">#to_csv</a>). Exemple de
fragment de tableau retourné:</p>

<pre>[ ..., &quot;0010,0000 (Group Length)&quot;, &quot;0010,0010 (Patient's Name)&quot;, ... ]</pre>
          

          
          <div class="method-source-code" id="csv_metadata_header-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 251</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">csv_metadata_header</span>
  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">csv_metadata_header_from</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">first</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- csv_metadata_header-source -->
          
        </div>

        

        
      </div><!-- csv_metadata_header-method -->

    
      <div id="method-i-empty-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">empty?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne <code>false</code> si une image DICOM de type quelconque (normale
ou <em>scout</em>) au moins a été trouvée dans le dossier source,
<code>true</code> dans le cas contraire et <code>nil</code> si aucun
fichier n’a encore été lu.</p>
          

          
          <div class="method-source-code" id="empty-3F-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 190</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@scouts</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">not</span>( <span class="ruby-identifier">has_images?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">has_scouts?</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- empty-3F-source -->
          
        </div>

        

        
      </div><!-- empty-3F-method -->

    
      <div id="method-i-has_homogeneous_structure-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_homogeneous_structure?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne true si la structure de données de toutes les images est homogène
(ou qu’il n’y a aucune image), false sinon.</p>
          

          
          <div class="method-source-code" id="has_homogeneous_structure-3F-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 197</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_homogeneous_structure?</span>
  <span class="ruby-comment"># Si déjà interrogé plus tôt, on s'épargne un recalcul</span>
  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@images_homogeneous</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@images_homogeneous</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># Sinon on examine la structure des images, deux par deux</span>
  <span class="ruby-identifier">homogeneous</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">prev_struct</span>, <span class="ruby-identifier">struct</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">each_value</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">prev_struct</span>, <span class="ruby-identifier">struct</span> = <span class="ruby-identifier">struct</span>, <span class="ruby-identifier">sign_structure_of</span>( <span class="ruby-identifier">dobject</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">prev_struct</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span>( <span class="ruby-identifier">struct</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">prev_struct</span>)
    <span class="ruby-identifier">homogeneous</span> = <span class="ruby-keyword">false</span>; <span class="ruby-keyword">break</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@images_homogeneous</span> = <span class="ruby-identifier">homogeneous</span>

  <span class="ruby-comment"># Plus succinct?</span>
  <span class="ruby-comment"># @images.map { |path,dobj| sign_structure_of dobj }.each_cons(2) \</span>
  <span class="ruby-comment">#   { |sig1,sig2| next if sig1 == sig2; homogeneous = false; break }</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- has_homogeneous_structure-3F-source -->
          
        </div>

        

        
      </div><!-- has_homogeneous_structure-3F-method -->

    
      <div id="method-i-has_images-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_images?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne <code>true</code> si une image DICOM au moins a été extraite du
dossier source, <code>false</code> dans le cas contraire et
<code>nil</code> si aucun fichier n’a encore été lu.</p>
          

          
          <div class="method-source-code" id="has_images-3F-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 176</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_images?</span>
  <span class="ruby-ivar">@images</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- has_images-3F-source -->
          
        </div>

        

        
      </div><!-- has_images-3F-method -->

    
      <div id="method-i-has_scouts-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">has_scouts?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne <code>true</code> si une image DICOM de type <em>scout</em> au
moins a été extraite du dossier source, <code>false</code> dans le cas
contraire et <code>nil</code> si aucun fichier n’a encore été lu.</p>
          

          
          <div class="method-source-code" id="has_scouts-3F-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 183</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">has_scouts?</span>
  <span class="ruby-ivar">@scouts</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@scouts</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- has_scouts-3F-source -->
          
        </div>

        

        
      </div><!-- has_scouts-3F-method -->

    
      <div id="method-i-images_already_read-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">images_already_read?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne true si les fichiers des images DICOM ont été intégralement lus
(dans quel cas @images et/ou @scouts contiennent des éléments)</p>
          

          
          <div class="method-source-code" id="images_already_read-3F-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">images_already_read?</span>
  <span class="ruby-ivar">@images_read</span>  <span class="ruby-comment"># comprendre @images_read == true, mais ne pas l'écrire!</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- images_already_read-3F-source -->
          
        </div>

        

        
      </div><!-- images_already_read-3F-method -->

    
      <div id="method-i-read_images" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_images</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Lecture de toutes les images DICOM qui se trouvent dans le dossier source
(qui doit évidemment avoir été défini, utiliser la méthode <a
href="Exam.html#attribute-i-source_dir">#source_dir</a>= pour ce faire).
Retourne le nombre d’images lues ou <code>nil</code> si les images ont déjà
été lues plus tôt.</p>

<p>Soulève une exception RuntimeError avec un message, si l’objet DICOM n’a
pas pu être créé, le fichier source ne peut pas être analysé ou que la
modalité n’est pas ‘CT’.</p>
          

          
          <div class="method-source-code" id="read_images-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 148</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">read_images</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">images_already_read?</span>

  <span class="ruby-identifier">image_files</span> = <span class="ruby-identifier">find_images_in</span> <span class="ruby-ivar">@source_dir</span>
  <span class="ruby-identifier">image_files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">dobject</span> = <span class="ruby-constant">DICOM</span><span class="ruby-operator">::</span><span class="ruby-constant">DObject</span>.<span class="ruby-identifier">read</span> <span class="ruby-identifier">path</span>
    <span class="ruby-identifier">assert_is_kind_of_dobject</span> <span class="ruby-identifier">dobject</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-comment"># the paranoïd freak in me</span>
    <span class="ruby-identifier">assert_successfully_read</span> <span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span>
    <span class="ruby-identifier">assert_modality_is_CTscan</span> <span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span>
    <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">remove</span>( <span class="ruby-constant">DICOM_PIXEL_DATA_TAG</span>)  <span class="ruby-comment"># pour diminuer l'empreinte mémoire</span>
    <span class="ruby-ivar">@images</span>[ <span class="ruby-identifier">path</span>] = <span class="ruby-identifier">dobject</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@images_read</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-comment"># NOTE: éxécuter prune_scout_images_from!() avant extract_exam_name(),</span>
  <span class="ruby-comment"># afin d'extraire le nom en priorité à partir des images de l'examen</span>
  <span class="ruby-ivar">@scouts</span> = <span class="ruby-identifier">prune_scout_images_from!</span> <span class="ruby-ivar">@images</span>
  <span class="ruby-ivar">@name</span> = <span class="ruby-identifier">extract_exam_name</span>

  <span class="ruby-identifier">sort_images_by!</span> <span class="ruby-identifier">options_extract</span>[<span class="ruby-value">:sort_images_by</span>]        <span class="ruby-keyword">if</span> <span class="ruby-identifier">options_extract</span>[<span class="ruby-value">:sort_images_by</span>]

  <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">count</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@scouts</span>.<span class="ruby-identifier">count</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- read_images-source -->
          
        </div>

        

        
      </div><!-- read_images-method -->

    
      <div id="method-i-sort_images_by" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sort_images_by</span><span
            class="method-args">( order = :slice_location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retourne une copie des images réordonnées selon l’argument
<code>order</code>:</p>
<ul><li>
<p>s’il vaut <code>:slice_location</code>, réordonne les images selon la
position de la tranche que chacune représente, c-à-d. la valeur de
l’élément “0020,1041 (Slice Location)”;</p>
</li><li>
<p>s’il vaut <code>false</code>, <code>nil</code> ou tout autre valeur,
retourne la collection d’images inchangée.</p>
</li></ul>
          

          
          <div class="method-source-code" id="sort_images_by-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 224</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sort_images_by</span>( <span class="ruby-identifier">order</span> = <span class="ruby-value">:slice_location</span>)
  <span class="ruby-keyword">return</span> {} <span class="ruby-keyword">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">order</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:slice_location</span>
      <span class="ruby-identifier">sorted_hash</span> = {}
      <span class="ruby-identifier">sorted_array</span> = <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">sort_by</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">exists?</span>( <span class="ruby-constant">DICOM_SLICE_LOCATION_TAG</span>)              <span class="ruby-operator">?</span> <span class="ruby-constant">Float</span>( <span class="ruby-identifier">dobject</span>[ <span class="ruby-constant">DICOM_SLICE_LOCATION_TAG</span>].<span class="ruby-identifier">value</span>)              <span class="ruby-operator">:</span> <span class="ruby-operator">-</span><span class="ruby-constant">Float</span><span class="ruby-operator">::</span><span class="ruby-constant">INFINITY</span>  <span class="ruby-comment"># images sans Slice Location: tout au début</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">sorted_array</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">path</span>, <span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sorted_hash</span>[ <span class="ruby-identifier">path</span>] = <span class="ruby-identifier">dobject</span> }
      <span class="ruby-identifier">sorted_hash</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@images</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- sort_images_by-source -->
          
        </div>

        

        
      </div><!-- sort_images_by-method -->

    
      <div id="method-i-sort_images_by-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sort_images_by!</span><span
            class="method-args">( order = :slice_location)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Identique à <a
href="Exam.html#method-i-sort_images_by">#sort_images_by</a>, si ce n’est
que les images de l’examen sont réordonnées « in place ».</p>
          

          
          <div class="method-source-code" id="sort_images_by-21-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 243</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sort_images_by!</span>( <span class="ruby-identifier">order</span> = <span class="ruby-value">:slice_location</span>)
  <span class="ruby-ivar">@images</span> = <span class="ruby-identifier">sort_images_by</span> <span class="ruby-identifier">order</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- sort_images_by-21-source -->
          
        </div>

        

        
      </div><!-- sort_images_by-21-method -->

    
      <div id="method-i-source_dir-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">source_dir=</span><span
            class="method-args">( dir_path)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Définit le chemin d’accès au dossier source, qui contient le jeu d’images
DICOM à traiter.</p>

<p>Commande ensuite le chargement des images du dossier source (en invoquant
la méthode <a href="Exam.html#method-i-read_images">#read_images</a>) – à
moins que l’option :defer_loading ne contienne true, dans quel cas le
chargement doit être commandé par une invocation explicite de read_images.</p>

<p>S’il y en avait déjà, commande auparavant l’effacement des images qui
étaient en mémoire.</p>

<p>Retourne le chemin d’accès effectivement mémorisé, après normalisation.</p>
          

          
          <div class="method-source-code" id="source_dir-3D-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">source_dir=</span>( <span class="ruby-identifier">dir_path</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">dir_path</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@source_dir</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">dir_path</span>
  <span class="ruby-identifier">reset!</span>    <span class="ruby-comment"># clear all data as source directory changed</span>
  <span class="ruby-ivar">@source_dir</span> = <span class="ruby-identifier">remove_last_dir_sep_from</span> <span class="ruby-identifier">dir_path</span>
  <span class="ruby-identifier">read_images</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@options_extract</span>[ <span class="ruby-value">:defer_loading</span>]
  <span class="ruby-ivar">@source_dir</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- source_dir-3D-source -->
          
        </div>

        

        
      </div><!-- source_dir-3D-method -->

    
      <div id="method-i-to_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_csv</span><span
            class="method-args">( output_file)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Transcrit les métadonnées d’une image DICOM dans un fichier CSV.</p>

<p>Le paramètre ‘output_file’ doit contenir un <em>objet</em> fichier dans
lequel il est possible d’écrire (non seulement le nom d’un fichier).</p>

<p>Soulève une exception RuntimeError si la structure des images n’est pas
homogène (ce qui signale plusieurs séries d’images différentes).</p>
          

          
          <div class="method-source-code" id="to_csv-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 263</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_csv</span>( <span class="ruby-identifier">output_file</span>)
  <span class="ruby-identifier">read_images</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;DICOM source files have inconsistent structure among them&quot;</span>        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_homogeneous_structure?</span>

  <span class="ruby-identifier">csv_options</span> = <span class="ruby-constant">DEFAULT_CSV_OPTIONS</span>
  <span class="ruby-constant">CSV</span>( <span class="ruby-identifier">output_file</span>, <span class="ruby-identifier">csv_options</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv_file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">csv_file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">csv_metadata_header</span>
    <span class="ruby-identifier">sort_images_by</span>( <span class="ruby-value">:slice_location</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">image</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">csv_file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">csv_metadata_values_from</span>( <span class="ruby-identifier">image</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- to_csv-source -->
          
        </div>

        

        
      </div><!-- to_csv-method -->

    
      <div id="method-i-to_html" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_html</span><span
            class="method-args">( output_file)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="to_html-source">
            <pre><span class="ruby-comment"># File lib/exam.rb, line 278</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_html</span>( <span class="ruby-identifier">output_file</span>)
  <span class="ruby-identifier">read_images</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@images</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;DICOM source files have inconsistent structure among them&quot;</span>        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_homogeneous_structure?</span>

  <span class="ruby-identifier">data</span> = []
  <span class="ruby-identifier">sort_images_by</span>( <span class="ruby-value">:slice_location</span>).<span class="ruby-identifier">values</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dobject</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">data</span> <span class="ruby-operator">&lt;&lt;</span> {
      <span class="ruby-value">:l</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">exists?</span>( <span class="ruby-constant">DICOM_SLICE_LOCATION_TAG</span>)            <span class="ruby-operator">?</span> <span class="ruby-constant">Float</span>( <span class="ruby-identifier">dobject</span>[ <span class="ruby-constant">DICOM_SLICE_LOCATION_TAG</span>].<span class="ruby-identifier">value</span>) <span class="ruby-operator">:</span> <span class="ruby-value">0.0</span>,
      <span class="ruby-value">:x</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">exists?</span>( <span class="ruby-constant">DICOM_XRAY_TUBE_CURRENT_TAG</span>)            <span class="ruby-operator">?</span> <span class="ruby-constant">Float</span>( <span class="ruby-identifier">dobject</span>[ <span class="ruby-constant">DICOM_XRAY_TUBE_CURRENT_TAG</span>].<span class="ruby-identifier">value</span>) <span class="ruby-operator">:</span> <span class="ruby-value">0.0</span>,
      <span class="ruby-value">:t</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dobject</span>.<span class="ruby-identifier">exists?</span>( <span class="ruby-constant">DICOM_EXPOSURE_TIME_TAG</span>)            <span class="ruby-operator">?</span> <span class="ruby-constant">Float</span>( <span class="ruby-identifier">dobject</span>[ <span class="ruby-constant">DICOM_EXPOSURE_TIME_TAG</span>].<span class="ruby-identifier">value</span>) <span class="ruby-operator">:</span> <span class="ruby-value">0.0</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">output_file</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">html_graph_for</span>( <span class="ruby-identifier">data</span>, <span class="ruby-ivar">@name</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- to_html-source -->
          
        </div>

        

        
      </div><!-- to_html-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

